version: '3.8'

services:
  # Independent PostgreSQL instance for VSD CMS
  vsd-cms-postgres:
    image: postgres:16-alpine
    container_name: vsd-cms-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=vsdcms
      - POSTGRES_PASSWORD=${DB_CMS_PASSWORD}
      - POSTGRES_DB=vsd_cms
    volumes:
      - cms_postgres_data:/var/lib/postgresql/data
    networks:
      - vsd-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vsdcms"]
      interval: 10s
      timeout: 5s
      retries: 5

  vsd-cms:
    image: mainul35/vsd:cmsV1
    container_name: vsd-cms
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DATABASE_URL=jdbc:postgresql://vsd-cms-postgres:5432/vsd_cms
      - DATABASE_USERNAME=vsdcms
      - DATABASE_PASSWORD=${DB_CMS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - AUTH_SERVER_ENABLED=true
      - AUTH_SERVER_ISSUER_URI=https://vsdauthserver.visualsitedesigner.com
      - AUTH_SERVER_JWK_URI=https://vsdauthserver.visualsitedesigner.com/oauth2/jwks
      - VSD_CMS_CLIENT_ID=vsd-cms-client
      - VSD_CMS_CLIENT_SECRET=${VSD_CMS_CLIENT_SECRET}
      - FRONTEND_URL=https://cms.visualsitedesigner.com
      - CORS_ALLOWED_ORIGINS=https://cms.visualsitedesigner.com
      - JAVA_OPTS=-Xmx512m -Xms256m
    expose:
      - "8080"
    volumes:
      - cms_data:/app/data
      - cms_plugins:/app/plugins
    depends_on:
      vsd-cms-postgres:
        condition: service_healthy
    networks:
      - vsd-network
      - vsd-auth-tunnel_default
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  vsd-network:
    driver: bridge
  vsd-auth-tunnel_default:
    external: true

volumes:
  cms_postgres_data:
  cms_data:
  cms_plugins:
