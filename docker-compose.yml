version: '3.8'

services:
  # Dynamic Site Builder Application
  vsd-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vsd-app
    ports:
      - "8080:8080"  # Exposed for Cloudflare Tunnel
    volumes:
      # Persist H2 database data
      - ./data:/app/data
      # Mount plugins directory for hot-reload support
      - ./plugins-runtime:/app/plugins
    environment:
      - SPRING_DATASOURCE_URL=jdbc:h2:file:/app/data/vsd-db
      - SERVER_PORT=8080
      # Plugin configuration
      - PLUGIN_DIRECTORY=/app/plugins
      # Trust Cloudflare proxy headers
      - SERVER_FORWARD_HEADERS_STRATEGY=FRAMEWORK
      - SERVER_TOMCAT_REMOTEIP_REMOTE_IP_HEADER=CF-Connecting-IP
      - SERVER_TOMCAT_REMOTEIP_PROTOCOL_HEADER=X-Forwarded-Proto
    restart: unless-stopped
    networks:
      - vsd-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Cloudflare Tunnel (cloudflared)
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: vsd-cloudflared
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - vsd-app
    restart: unless-stopped
    networks:
      - vsd-network

networks:
  vsd-network:
    driver: bridge
